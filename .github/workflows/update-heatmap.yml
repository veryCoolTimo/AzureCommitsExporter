name: Update Commits Heatmap

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  update-heatmap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Generate heatmap
        env:
          AZURE_ORG: ${{ vars.AZURE_ORG }}
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GH_USERNAME: ${{ vars.GH_USERNAME }}
          AUTHOR_EMAILS: ${{ vars.AUTHOR_EMAILS }}
        run: python scripts/generate_heatmap.py

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add commits-heatmap.svg STATS.md
          git diff --staged --quiet || git commit -m "Update commits heatmap [skip ci]"
          git pull --rebase -X theirs || true
          git push --force-with-lease

      - name: Update profile README
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # Read stats from STATS.md
          TOTAL=$(grep "Total commits" STATS.md | grep -oE '[0-9]+')
          CURRENT=$(grep "Current streak" STATS.md | grep -oE '[0-9]+' | head -1)
          MAX=$(grep "Max streak" STATS.md | grep -oE '[0-9]+' | head -1)

          # Create stats line
          STATS_LINE="üî• **Current streak:** ${CURRENT} days  ‚Ä¢  üèÜ **Max streak:** ${MAX} days  ‚Ä¢  üìä **Total:** ${TOTAL} commits"

          # Clone profile repo
          git clone https://x-access-token:${GH_PAT}@github.com/veryCoolTimo/veryCoolTimo.git profile-repo
          cd profile-repo

          # Update README between markers using perl for multiline
          perl -i -p0e "s|<!-- STATS:START -->.*?<!-- STATS:END -->|<!-- STATS:START -->\n${STATS_LINE}\n<!-- STATS:END -->|s" README.md

          # Commit and push if changed
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add README.md
          git diff --staged --quiet || git commit -m "Update stats [skip ci]"
          git push || true
